---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="WebPè½¬JPGå·¥å…· - æå®¢çŒ¿å·¥å…·ç®±">
  <main class="max-w-4xl mx-auto px-4 py-4 sm:py-8">
    <div class="space-y-4 sm:space-y-6">
      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div 
        id="dropArea" 
        class="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 sm:p-8 text-center cursor-pointer hover:border-blue-500 transition-colors"
      >
        <div class="flex flex-col items-center justify-center space-y-2 sm:space-y-3">
          <span class="text-3xl sm:text-4xl">ğŸ“</span>
          <p class="text-sm sm:text-base text-gray-600">
            ç‚¹å‡»æˆ–æ‹–æ”¾WebPå›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ 
          </p>
          <p class="text-xs text-gray-500">æ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šä¸ªæ–‡ä»¶</p>
          <input 
            type="file" 
            id="fileInput" 
            class="hidden" 
            accept=".webp" 
            multiple
          />
          <button
            id="selectFilesBtn"
            class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition-colors"
          >
            é€‰æ‹©æ–‡ä»¶
          </button>
        </div>
      </div>

      <!-- è½¬æ¢è¿›åº¦ -->
      <div id="progressContainer" class="hidden">
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progressBar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <p class="text-xs text-gray-500 mt-1 text-center">
          <span id="progressText">0%</span> - æ­£åœ¨å¤„ç† <span id="currentFile">0</span>/<span id="totalFiles">0</span>
        </p>
      </div>

      <!-- è½¬æ¢ç»“æœ -->
      <div id="resultContainer" class="hidden space-y-4">
        <div class="flex justify-between items-center">
          <h2 class="text-base sm:text-lg font-semibold">è½¬æ¢ç»“æœ</h2>
          <div class="flex space-x-2">
            <button
              id="downloadAllBtn"
              class="px-3 sm:px-4 py-1.5 sm:py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
              disabled
            >
              ä¸‹è½½å…¨éƒ¨
            </button>
            <button
              id="clearAllBtn"
              class="px-3 sm:px-4 py-1.5 sm:py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
            >
              æ¸…ç©º
            </button>
          </div>
        </div>
        
        <div id="imageResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 sm:gap-4">
          <!-- è½¬æ¢åçš„å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // @ts-nocheck
  // DOMå…ƒç´ 
  const dropArea = document.getElementById('dropArea');
  const fileInput = document.getElementById('fileInput');
  const selectFilesBtn = document.getElementById('selectFilesBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const currentFile = document.getElementById('currentFile');
  const totalFiles = document.getElementById('totalFiles');
  const resultContainer = document.getElementById('resultContainer');
  const imageResults = document.getElementById('imageResults');
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');

  // å­˜å‚¨è½¬æ¢åçš„å›¾ç‰‡
  let convertedImages = [];

  // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æŒ‰é’®
  selectFilesBtn.addEventListener('click', () => {
    fileInput.click();
  });

  // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
  dropArea.addEventListener('click', () => {
    fileInput.click();
  });

  // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
  fileInput.addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 0) {
      handleFiles(files);
    }
  });

  // æ‹–æ”¾äº‹ä»¶
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false);
  });

  function highlight() {
    dropArea.classList.add('border-blue-500');
  }

  function unhighlight() {
    dropArea.classList.remove('border-blue-500');
  }

  dropArea.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
  });

  // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
  function handleFiles(files) {
    // è¿‡æ»¤å‡ºWebPæ–‡ä»¶
    const webpFiles = Array.from(files).filter(file => 
      file.type === 'image/webp' || file.name.toLowerCase().endsWith('.webp')
    );

    if (webpFiles.length === 0) {
      alert('è¯·ä¸Šä¼ WebPæ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶');
      return;
    }

    // æ˜¾ç¤ºè¿›åº¦æ¡
    progressContainer.classList.remove('hidden');
    resultContainer.classList.remove('hidden');
    
    // æ›´æ–°è¿›åº¦ä¿¡æ¯
    totalFiles.textContent = webpFiles.length;
    currentFile.textContent = '0';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';

    // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
    convertedImages = [];
    downloadAllBtn.disabled = true;

    // å¼€å§‹è½¬æ¢
    convertFiles(webpFiles);
  }

  // è½¬æ¢æ–‡ä»¶
  async function convertFiles(files) {
    let processed = 0;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      
      // æ›´æ–°å½“å‰å¤„ç†çš„æ–‡ä»¶
      currentFile.textContent = (i + 1).toString();
      
      try {
        // è¯»å–æ–‡ä»¶
        const imageUrl = await readFileAsDataURL(file);
        
        // è½¬æ¢å›¾ç‰‡
        const jpgBlob = await convertWebpToJpg(imageUrl, file.name);
        
        // æ·»åŠ åˆ°ç»“æœ
        addImageToResults(jpgBlob, file.name.replace(/\.webp$/i, '.jpg'));
        
        // å­˜å‚¨è½¬æ¢åçš„å›¾ç‰‡
        convertedImages.push({
          blob: jpgBlob,
          name: file.name.replace(/\.webp$/i, '.jpg')
        });
        
        // æ›´æ–°è¿›åº¦
        processed++;
        const progress = Math.round((processed / files.length) * 100);
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${progress}%`;
      } catch (error) {
        console.error('è½¬æ¢å¤±è´¥:', error);
      }
    }

    // å¯ç”¨ä¸‹è½½å…¨éƒ¨æŒ‰é’®
    if (convertedImages.length > 0) {
      downloadAllBtn.disabled = false;
    }
  }

  // è¯»å–æ–‡ä»¶ä¸ºDataURL
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // å°†WebPè½¬æ¢ä¸ºJPG
  function convertWebpToJpg(webpUrl, fileName) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        // åˆ›å»ºcanvas
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        
        // ç»˜åˆ¶å›¾ç‰‡
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        
        // è½¬æ¢ä¸ºJPG
        canvas.toBlob(blob => {
          resolve(blob);
        }, 'image/jpeg', 0.9);
      };
      img.onerror = () => {
        reject(new Error(`æ— æ³•åŠ è½½å›¾ç‰‡: ${fileName}`));
      };
      img.src = webpUrl;
    });
  }

  // æ·»åŠ å›¾ç‰‡åˆ°ç»“æœåŒºåŸŸ
  function addImageToResults(blob, fileName) {
    const url = URL.createObjectURL(blob);
    
    const imageCard = document.createElement('div');
    imageCard.className = 'bg-white border border-gray-200 rounded-lg overflow-hidden';
    
    const imageContainer = document.createElement('div');
    imageContainer.className = 'aspect-square overflow-hidden';
    
    const img = document.createElement('img');
    img.src = url;
    img.className = 'w-full h-full object-cover';
    img.alt = fileName;
    
    const infoContainer = document.createElement('div');
    infoContainer.className = 'p-2 text-xs';
    
    const nameElement = document.createElement('p');
    nameElement.className = 'truncate text-gray-700';
    nameElement.textContent = fileName;
    
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'mt-1 w-full px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs transition-colors';
    downloadBtn.textContent = 'ä¸‹è½½';
    downloadBtn.onclick = () => downloadImage(blob, fileName);
    
    infoContainer.appendChild(nameElement);
    infoContainer.appendChild(downloadBtn);
    imageContainer.appendChild(img);
    imageCard.appendChild(imageContainer);
    imageCard.appendChild(infoContainer);
    
    imageResults.appendChild(imageCard);
  }

  // ä¸‹è½½å•ä¸ªå›¾ç‰‡
  function downloadImage(blob, fileName) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
  downloadAllBtn.addEventListener('click', async () => {
    if (convertedImages.length === 0) return;
    
    if (convertedImages.length === 1) {
      // å¦‚æœåªæœ‰ä¸€ä¸ªå›¾ç‰‡ï¼Œç›´æ¥ä¸‹è½½
      downloadImage(convertedImages[0].blob, convertedImages[0].name);
    } else {
      // å¦‚æœæœ‰å¤šä¸ªå›¾ç‰‡ï¼Œåˆ›å»ºä¸€ä¸ªZIPæ–‡ä»¶
      try {
        // åŠ¨æ€åŠ è½½JSZipåº“
        if (typeof window.JSZip === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
          document.head.appendChild(script);
          
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }
        
        // ä½¿ç”¨å…¨å±€JSZipå¯¹è±¡
        const JSZip = window.JSZip || globalThis.JSZip;
        const zip = new JSZip();
        
        // æ·»åŠ æ‰€æœ‰å›¾ç‰‡åˆ°ZIP
        convertedImages.forEach(img => {
          zip.file(img.name, img.blob);
        });
        
        // ç”ŸæˆZIPæ–‡ä»¶
        const zipBlob = await zip.generateAsync({type: 'blob'});
        
        // ä¸‹è½½ZIPæ–‡ä»¶
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'webp-to-jpg.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('åˆ›å»ºZIPæ–‡ä»¶å¤±è´¥:', error);
        alert('æ‰¹é‡ä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•å•ä¸ªä¸‹è½½');
      }
    }
  });

  // æ¸…ç©ºæ‰€æœ‰ç»“æœ
  clearAllBtn.addEventListener('click', () => {
    imageResults.innerHTML = '';
    convertedImages = [];
    downloadAllBtn.disabled = true;
    progressContainer.classList.add('hidden');
    
    // å¦‚æœç»“æœä¸ºç©ºï¼Œéšè—ç»“æœå®¹å™¨
    if (imageResults.children.length === 0) {
      resultContainer.classList.add('hidden');
    }
  });
</script>

<style>
  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
  #imageResults {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
  }
  #imageResults::-webkit-scrollbar {
    width: 6px;
  }
  #imageResults::-webkit-scrollbar-track {
    background: transparent;
  }
  #imageResults::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }
</style> 