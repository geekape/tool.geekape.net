---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="æ–‡ä»¶é‡å‘½åå·¥å…· - æå®¢çŒ¿å·¥å…·ç®±">
  <main class="max-w-4xl mx-auto px-4 py-4 sm:py-8">
    <div class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold mb-2">æ–‡ä»¶é‡å‘½åå·¥å…·</h1>
      <p class="text-gray-600">æ‰¹é‡æ–‡ä»¶é‡å‘½åå·¥å…·ï¼Œæ”¯æŒå¤šç§é‡å‘½åæ–¹å¼</p>
    </div>

    <div class="space-y-6">
      <!-- æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6">
        <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" id="dropZone">
          <div class="mb-4">
            <span class="text-4xl">ğŸ“</span>
          </div>
          <p class="mb-4 text-gray-600">æ‹–æ”¾æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
          <div class="flex space-x-4">
            <button id="selectFiles" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
              é€‰æ‹©æ–‡ä»¶
            </button>
            <button id="selectFolder" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
              é€‰æ‹©æ–‡ä»¶å¤¹
            </button>
          </div>
          <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å…ƒç´  -->
          <input type="file" id="fileInput" multiple style="display: none;" />
          <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" />
        </div>
      </div>

      <!-- æ‰©å±•åä¿®æ”¹é€‰é¡¹ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold mb-4">æ‰©å±•åä¿®æ”¹é€‰é¡¹</h2>
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1">
            <label for="newExtension" class="block text-sm font-medium text-gray-700 mb-1">ä¿®æ”¹æ‰©å±•å</label>
            <input
              type="text"
              id="newExtension"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="è¾“å…¥æ–°æ‰©å±•åï¼ˆä¸å«ç‚¹å·ï¼‰"
            />
          </div>
          <div class="flex-1">
            <label for="extensionCase" class="block text-sm font-medium text-gray-700 mb-1">æ‰©å±•åå¤§å°å†™</label>
            <select
              id="extensionCase"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="noChange">ä¸æ”¹å˜</option>
              <option value="uppercase">è½¬ä¸ºå¤§å†™</option>
              <option value="lowercase">è½¬ä¸ºå°å†™</option>
            </select>
          </div>
        </div>
      </div>

      <!-- æ–‡ä»¶åä¿®æ”¹é€‰é¡¹ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold mb-4">æ–‡ä»¶åä¿®æ”¹é€‰é¡¹</h2>
        
        <div class="mb-4">
          <label for="newFilename" class="block text-sm font-medium text-gray-700 mb-1">æ–°æ–‡ä»¶åï¼š</label>
          <input
            type="text"
            id="newFilename"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="è¾“å…¥æ–°æ–‡ä»¶åï¼ˆç•™ç©ºåˆ™ä¿æŒåŸæ–‡ä»¶åï¼‰"
          />
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="filenameCase" class="block text-sm font-medium text-gray-700 mb-1">æ–‡ä»¶åå¤§å°å†™</label>
            <select
              id="filenameCase"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="noChange">ä¸æ”¹å˜</option>
              <option value="uppercase">è½¬ä¸ºå¤§å†™</option>
              <option value="lowercase">è½¬ä¸ºå°å†™</option>
              <option value="capitalize">é¦–å­—æ¯å¤§å†™</option>
            </select>
          </div>
          
          <div>
            <label for="addNumber" class="block text-sm font-medium text-gray-700 mb-1">æ·»åŠ åºå·</label>
            <div class="flex gap-2">
              <select
                id="numberPosition"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="none">ä¸æ·»åŠ </option>
                <option value="prefix">å‰ç¼€</option>
                <option value="suffix">åç¼€</option>
              </select>
              <input
                type="number"
                id="startNumber"
                class="w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="èµ·å§‹å€¼"
                value="1"
                min="0"
              />
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="addTime" class="block text-sm font-medium text-gray-700 mb-1">æ·»åŠ æ—¶é—´æˆ³</label>
            <select
              id="timePosition"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="none">ä¸æ·»åŠ </option>
              <option value="prefix">å‰ç¼€</option>
              <option value="suffix">åç¼€</option>
            </select>
          </div>
          
          <div>
            <label for="timeFormat" class="block text-sm font-medium text-gray-700 mb-1">æ—¶é—´æ ¼å¼</label>
            <select
              id="timeFormat"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="yyyyMMdd">å¹´æœˆæ—¥ (yyyyMMdd)</option>
              <option value="yyyyMMddHHmm">å¹´æœˆæ—¥æ—¶åˆ† (yyyyMMddHHmm)</option>
              <option value="yyyyMMddHHmmss">å¹´æœˆæ—¥æ—¶åˆ†ç§’ (yyyyMMddHHmmss)</option>
              <option value="HHmmss">æ—¶åˆ†ç§’ (HHmmss)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- æ’åºé€‰é¡¹ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold mb-4">æ’åºé€‰é¡¹</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="inline-flex items-center">
              <input type="radio" name="sortOrder" value="natural" class="form-radio" checked>
              <span class="ml-2">è‡ªç„¶æ’åº</span>
            </label>
          </div>
          <div>
            <label class="inline-flex items-center">
              <input type="radio" name="sortOrder" value="nameAsc" class="form-radio">
              <span class="ml-2">æ–‡ä»¶åé¡ºåº</span>
            </label>
          </div>
          <div>
            <label class="inline-flex items-center">
              <input type="radio" name="sortOrder" value="nameDesc" class="form-radio">
              <span class="ml-2">æ–‡ä»¶åé€†åº</span>
            </label>
          </div>
          <div>
            <label class="inline-flex items-center">
              <input type="radio" name="sortOrder" value="timeAsc" class="form-radio">
              <span class="ml-2">ä¿®æ”¹æ—¶é—´é¡ºåº</span>
            </label>
          </div>
          <div>
            <label class="inline-flex items-center">
              <input type="radio" name="sortOrder" value="timeDesc" class="form-radio">
              <span class="ml-2">ä¿®æ”¹æ—¶é—´é€†åº</span>
            </label>
          </div>
          <div>
            <label class="inline-flex items-center">
              <input type="radio" name="sortOrder" value="random" class="form-radio">
              <span class="ml-2">éšæœºæ’åº</span>
            </label>
          </div>
          <div>
            <label class="inline-flex items-center">
              <input type="radio" name="sortOrder" value="reverse" class="form-radio">
              <span class="ml-2">åè½¬å½“å‰æ’åº</span>
            </label>
          </div>
        </div>
      </div>

      <!-- æ–‡ä»¶åˆ—è¡¨ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg sm:text-xl font-semibold">æ–‡ä»¶åˆ—è¡¨</h2>
          <button id="previewBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors" disabled>
            é¢„è§ˆé‡å‘½å
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  åŸæ–‡ä»¶å
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  æ–°æ–‡ä»¶å
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  çŠ¶æ€
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody id="fileList" class="bg-white divide-y divide-gray-200">
              <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
              <tr>
                <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                  è¯·é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="flex justify-end space-x-4">
        <button id="resetBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors">
          é‡ç½®
        </button>
        <button id="downloadBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors" disabled>
          æ‰“åŒ…ä¸‹è½½
        </button>
        <button id="renameBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors" disabled>
          æ‰§è¡Œé‡å‘½å
        </button>
      </div>
    </div>
  </main>
</Layout>

<!-- å¼•å…¥ JSZip åº“ -->
<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script is:inline>
  // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
  document.addEventListener('DOMContentLoaded', function() {
    // å®šä¹‰æ–‡ä»¶ç±»å‹æ¥å£
    // æ–‡ä»¶åˆ—è¡¨
    let files = [];
    let previewNames = [];
    let currentSortOrder = 'natural'; // å½“å‰æ’åºæ–¹å¼
    
    // DOM å…ƒç´ 
    const selectFilesBtn = document.getElementById('selectFiles');
    const selectFolderBtn = document.getElementById('selectFolder');
    const fileListEl = document.getElementById('fileList');
    const previewBtn = document.getElementById('previewBtn');
    const renameBtn = document.getElementById('renameBtn');
    const resetBtn = document.getElementById('resetBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const dropZone = document.getElementById('dropZone');
    const sortRadios = document.querySelectorAll('input[name="sortOrder"]');
    const fileInput = document.getElementById('fileInput');
    const folderInput = document.getElementById('folderInput');
    
    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    if (selectFilesBtn) {
      selectFilesBtn.addEventListener('click', () => {
        console.log('é€‰æ‹©æ–‡ä»¶æŒ‰é’®è¢«ç‚¹å‡»');
        // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
        if (fileInput) {
          fileInput.click();
        } else {
          // å¦‚æœæ–‡ä»¶è¾“å…¥å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
          simulateFileSelection();
        }
      });
    }
    
    if (selectFolderBtn) {
      selectFolderBtn.addEventListener('click', () => {
        console.log('é€‰æ‹©æ–‡ä»¶å¤¹æŒ‰é’®è¢«ç‚¹å‡»');
        // è§¦å‘æ–‡ä»¶å¤¹é€‰æ‹©å¯¹è¯æ¡†
        if (folderInput) {
          folderInput.click();
        } else {
          // å¦‚æœæ–‡ä»¶å¤¹è¾“å…¥å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
          simulateFileSelection();
        }
      });
    }
    
    // æ–‡ä»¶è¾“å…¥å…ƒç´ å˜åŒ–å¤„ç†
    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        console.log('æ–‡ä»¶è¾“å…¥å˜åŒ–');
        handleFileSelection(e.target.files);
      });
    }
    
    // æ–‡ä»¶å¤¹è¾“å…¥å…ƒç´ å˜åŒ–å¤„ç†
    if (folderInput) {
      folderInput.addEventListener('change', (e) => {
        console.log('æ–‡ä»¶å¤¹è¾“å…¥å˜åŒ–');
        handleFileSelection(e.target.files);
      });
    }
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelection(fileList) {
      if (!fileList || fileList.length === 0) {
        console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
        return;
      }
      
      console.log('é€‰æ‹©äº†', fileList.length, 'ä¸ªæ–‡ä»¶');
      
      // æ¸…ç©ºç°æœ‰æ–‡ä»¶åˆ—è¡¨
      files = [];
      
      // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
      Array.from(fileList).forEach(file => {
        const fileName = file.name;
        const lastDotIndex = fileName.lastIndexOf('.');
        const ext = lastDotIndex > 0 ? fileName.substring(lastDotIndex + 1) : '';
        const name = fileName;
        
        files.push({
          name: name,
          ext: ext,
          path: URL.createObjectURL(file),
          originalFile: file,  // ä¿å­˜åŸå§‹æ–‡ä»¶å¯¹è±¡ï¼Œç”¨äºä¸‹è½½
          lastModified: new Date(file.lastModified)
        });
      });
      
      // åº”ç”¨å½“å‰æ’åº
      sortFiles();
      
      // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
      updateFileList();
      if (previewBtn) previewBtn.disabled = false;
    }
    
    // é¢„è§ˆæŒ‰é’®
    if (previewBtn) {
      previewBtn.addEventListener('click', () => {
        console.log('é¢„è§ˆæŒ‰é’®è¢«ç‚¹å‡»');
        previewRename();
      });
    }
    
    // é‡å‘½åæŒ‰é’®
    if (renameBtn) {
      renameBtn.addEventListener('click', () => {
        console.log('é‡å‘½åæŒ‰é’®è¢«ç‚¹å‡»');
        executeRename();
      });
    }
    
    // é‡ç½®æŒ‰é’®
    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        console.log('é‡ç½®æŒ‰é’®è¢«ç‚¹å‡»');
        resetForm();
      });
    }
    
    // ä¸‹è½½æŒ‰é’®
    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        console.log('ä¸‹è½½æŒ‰é’®è¢«ç‚¹å‡»');
        packAndDownload();
      });
    }
    
    // æ’åºé€‰é¡¹å¤„ç†
    if (sortRadios && sortRadios.length > 0) {
      sortRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
          const sortValue = e.target.value;
          console.log('æ’åºæ–¹å¼æ”¹å˜ä¸º:', sortValue);
          currentSortOrder = sortValue;
          sortFiles();
          updateFileList();
        });
      });
    }
    
    // æ’åºæ–‡ä»¶
    function sortFiles() {
      if (files.length <= 1) return; // æ— éœ€æ’åº
      
      console.log('æ‰§è¡Œæ–‡ä»¶æ’åºï¼Œæ–¹å¼:', currentSortOrder);
      
      switch (currentSortOrder) {
        case 'natural':
          // è‡ªç„¶æ’åºï¼Œä¿æŒåŸæ ·
          break;
          
        case 'nameAsc':
          // æ–‡ä»¶åé¡ºåº
          files.sort((a, b) => a.name.localeCompare(b.name));
          break;
          
        case 'nameDesc':
          // æ–‡ä»¶åé€†åº
          files.sort((a, b) => b.name.localeCompare(a.name));
          break;
          
        case 'timeAsc':
          // ä¿®æ”¹æ—¶é—´é¡ºåº
          files.sort((a, b) => a.lastModified.getTime() - b.lastModified.getTime());
          break;
          
        case 'timeDesc':
          // ä¿®æ”¹æ—¶é—´é€†åº
          files.sort((a, b) => b.lastModified.getTime() - a.lastModified.getTime());
          break;
          
        case 'random':
          // éšæœºæ’åº
          files.sort(() => Math.random() - 0.5);
          break;
          
        case 'reverse':
          // åè½¬å½“å‰æ’åº
          files.reverse();
          break;
      }
      
      // å¦‚æœæœ‰é¢„è§ˆåç§°ï¼Œä¹Ÿéœ€è¦ç›¸åº”è°ƒæ•´
      if (previewNames.length > 0) {
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ•°ç»„æ¥å­˜å‚¨æ’åºåçš„é¢„è§ˆåç§°
        const tempPreviewNames = [];
        files.forEach((file, index) => {
          // æŸ¥æ‰¾åŸå§‹æ–‡ä»¶åœ¨æ’åºå‰çš„ç´¢å¼•
          const originalIndex = files.findIndex(f => f === file);
          // å¦‚æœæ‰¾åˆ°å¯¹åº”çš„é¢„è§ˆåç§°ï¼Œåˆ™æ·»åŠ åˆ°ä¸´æ—¶æ•°ç»„
          if (originalIndex >= 0 && originalIndex < previewNames.length) {
            tempPreviewNames.push(previewNames[originalIndex]);
          } else {
            tempPreviewNames.push('');
          }
        });
        previewNames = tempPreviewNames;
      }
    }
    
    // é¢„è§ˆé‡å‘½å
    function previewRename() {
      console.log('é¢„è§ˆé‡å‘½å');
      // è·å–å„ä¸ªé€‰é¡¹çš„å€¼
      const newExtElement = document.getElementById('newExtension');
      const extCaseElement = document.getElementById('extensionCase');
      const newFilenameElement = document.getElementById('newFilename');
      const filenameCaseElement = document.getElementById('filenameCase');
      const numberPositionElement = document.getElementById('numberPosition');
      const startNumberElement = document.getElementById('startNumber');
      const timePositionElement = document.getElementById('timePosition');
      const timeFormatElement = document.getElementById('timeFormat');
      
      const newExt = newExtElement ? newExtElement.value : '';
      const extCase = extCaseElement ? extCaseElement.value : 'noChange';
      const newFilename = newFilenameElement ? newFilenameElement.value : '';
      const filenameCase = filenameCaseElement ? filenameCaseElement.value : 'noChange';
      const numberPosition = numberPositionElement ? numberPositionElement.value : 'none';
      const startNumber = startNumberElement ? (parseInt(startNumberElement.value) || 1) : 1;
      const timePosition = timePositionElement ? timePositionElement.value : 'none';
      const timeFormat = timeFormatElement ? timeFormatElement.value : 'yyyyMMdd';
      
      // ç”Ÿæˆé¢„è§ˆåç§°
      previewNames = files.map((file, index) => {
        // åˆ†ç¦»æ–‡ä»¶åå’Œæ‰©å±•å
        let filename = file.name.substring(0, file.name.lastIndexOf('.'));
        let ext = file.name.substring(file.name.lastIndexOf('.') + 1);
        
        // å¤„ç†æ–°æ–‡ä»¶å
        if (newFilename) {
          filename = newFilename;
        }
        
        // å¤„ç†æ–‡ä»¶åå¤§å°å†™
        if (filenameCase === 'uppercase') {
          filename = filename.toUpperCase();
        } else if (filenameCase === 'lowercase') {
          filename = filename.toLowerCase();
        } else if (filenameCase === 'capitalize') {
          filename = filename.charAt(0).toUpperCase() + filename.slice(1);
        }
        
        // å¤„ç†åºå·
        if (numberPosition === 'prefix') {
          const num = (startNumber + index).toString().padStart(2, '0');
          filename = `${num}_${filename}`;
        } else if (numberPosition === 'suffix') {
          const num = (startNumber + index).toString().padStart(2, '0');
          filename = `${filename}_${num}`;
        }
        
        // å¤„ç†æ—¶é—´æˆ³
        if (timePosition !== 'none') {
          const now = new Date();
          let timeStr = '';
          
          if (timeFormat === 'yyyyMMdd') {
            timeStr = now.toISOString().slice(0, 10).replace(/-/g, '');
          } else if (timeFormat === 'yyyyMMddHHmm') {
            timeStr = now.toISOString().slice(0, 16).replace(/-/g, '').replace('T', '').replace(':', '');
          } else if (timeFormat === 'yyyyMMddHHmmss') {
            timeStr = now.toISOString().slice(0, 19).replace(/-/g, '').replace('T', '').replace(/:/g, '');
          } else if (timeFormat === 'HHmmss') {
            timeStr = now.toISOString().slice(11, 19).replace(/:/g, '');
          }
          
          if (timePosition === 'prefix') {
            filename = `${timeStr}_${filename}`;
          } else if (timePosition === 'suffix') {
            filename = `${filename}_${timeStr}`;
          }
        }
        
        // å¤„ç†æ‰©å±•å
        if (newExt) {
          ext = newExt;
        }
        
        // å¤„ç†æ‰©å±•åå¤§å°å†™
        if (extCase === 'uppercase') {
          ext = ext.toUpperCase();
        } else if (extCase === 'lowercase') {
          ext = ext.toLowerCase();
        }
        
        return `${filename}.${ext}`;
      });
      
      updateFileList();
      if (previewBtn) previewBtn.disabled = false;
      if (downloadBtn) downloadBtn.disabled = true;
    }
    
    // æ‰§è¡Œé‡å‘½å
    function executeRename() {
      console.log('æ‰§è¡Œé‡å‘½å');
      // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šæ‰§è¡Œå®é™…çš„æ–‡ä»¶é‡å‘½åæ“ä½œ
      // ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œè¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿæ“ä½œ
      alert('å·²åº”ç”¨é‡å‘½åç»“æœï¼Œæ‚¨å¯ä»¥ç‚¹å‡»"æ‰“åŒ…ä¸‹è½½"ä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼Œæˆ–ç‚¹å‡»å•ä¸ªæ–‡ä»¶çš„ä¸‹è½½æŒ‰é’®ä¸‹è½½å•ä¸ªæ–‡ä»¶ã€‚');
      
      // æ›´æ–°æ–‡ä»¶å
      files.forEach((file, index) => {
        if (previewNames[index]) {
          file.name = previewNames[index];
        }
      });
      
      // é‡ç½®é¢„è§ˆ
      previewNames = [];
      updateFileList();
      if (renameBtn) renameBtn.disabled = true;
      if (downloadBtn) downloadBtn.disabled = false;
    }
    
    // é‡ç½®è¡¨å•
    function resetForm() {
      console.log('é‡ç½®è¡¨å•');
      const newExtElement = document.getElementById('newExtension');
      const extCaseElement = document.getElementById('extensionCase');
      const newFilenameElement = document.getElementById('newFilename');
      const filenameCaseElement = document.getElementById('filenameCase');
      const numberPositionElement = document.getElementById('numberPosition');
      const startNumberElement = document.getElementById('startNumber');
      const timePositionElement = document.getElementById('timePosition');
      const timeFormatElement = document.getElementById('timeFormat');
      
      if (newExtElement) newExtElement.value = '';
      if (extCaseElement) extCaseElement.value = 'noChange';
      if (newFilenameElement) newFilenameElement.value = '';
      if (filenameCaseElement) filenameCaseElement.value = 'noChange';
      if (numberPositionElement) numberPositionElement.value = 'none';
      if (startNumberElement) startNumberElement.value = '1';
      if (timePositionElement) timePositionElement.value = 'none';
      if (timeFormatElement) timeFormatElement.value = 'yyyyMMdd';
      
      // é‡ç½®æ’åº
      if (sortRadios && sortRadios.length > 0) {
        sortRadios.forEach(radio => {
          if (radio.value === 'natural') {
            radio.checked = true;
          } else {
            radio.checked = false;
          }
        });
        currentSortOrder = 'natural';
      }
      
      // é‡ç½®é¢„è§ˆ
      previewNames = [];
      updateFileList();
      if (renameBtn) renameBtn.disabled = true;
      if (downloadBtn) downloadBtn.disabled = true;
    }
    
    // æ‹–æ”¾æ–‡ä»¶å¤„ç†
    if (dropZone) {
      console.log('è®¾ç½®æ‹–æ”¾åŒºåŸŸäº‹ä»¶');
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        console.log('æ–‡ä»¶æ‹–åŠ¨åˆ°åŒºåŸŸä¸Šæ–¹');
        dropZone.classList.add('border-blue-500');
      });
      
      dropZone.addEventListener('dragleave', () => {
        console.log('æ–‡ä»¶ç¦»å¼€æ‹–æ”¾åŒºåŸŸ');
        dropZone.classList.remove('border-blue-500');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        console.log('æ–‡ä»¶è¢«æ‹–æ”¾åˆ°åŒºåŸŸä¸­');
        dropZone.classList.remove('border-blue-500');
        
        // å¤„ç†æ‹–æ”¾çš„æ–‡ä»¶
        if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
          handleFileSelection(e.dataTransfer.files);
        } else {
          // å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
          simulateFileSelection();
        }
      });
    }
    
    // æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©
    function simulateFileSelection() {
      console.log('æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©');
      // æ¨¡æ‹Ÿä¸€äº›ç¤ºä¾‹æ–‡ä»¶
      files = [
        { name: 'document.pdf', ext: 'pdf', path: '/path/to/document.pdf', lastModified: new Date(2023, 0, 15) },
        { name: 'image.jpg', ext: 'jpg', path: '/path/to/image.jpg', lastModified: new Date(2023, 1, 20) },
        { name: 'spreadsheet.xlsx', ext: 'xlsx', path: '/path/to/spreadsheet.xlsx', lastModified: new Date(2023, 2, 10) },
        { name: 'presentation.pptx', ext: 'pptx', path: '/path/to/presentation.pptx', lastModified: new Date(2023, 3, 5) },
        { name: 'notes.txt', ext: 'txt', path: '/path/to/notes.txt', lastModified: new Date(2023, 4, 25) }
      ];
      
      // åº”ç”¨å½“å‰æ’åº
      sortFiles();
      
      updateFileList();
      if (previewBtn) previewBtn.disabled = false;
    }
    
    // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
    function updateFileList() {
      console.log('æ›´æ–°æ–‡ä»¶åˆ—è¡¨');
      if (!fileListEl) return;
      
      if (files.length === 0) {
        fileListEl.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-gray-500">
              è¯·é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      files.forEach((file, index) => {
        const newName = previewNames[index] || file.name;
        html += `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <span class="text-sm font-medium text-gray-900">${file.name}</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <span class="text-sm font-medium ${previewNames[index] ? 'text-green-600' : 'text-gray-400'}">${newName}</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${previewNames[index] ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                ${previewNames[index] ? 'å·²é¢„è§ˆ' : 'æœªä¿®æ”¹'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button 
                class="text-blue-600 hover:text-blue-900 focus:outline-none"
                data-index="${index}"
              >
                ä¸‹è½½
              </button>
            </td>
          </tr>
        `;
      });
      
      fileListEl.innerHTML = html;
      
      // ä¸ºæ¯ä¸ªä¸‹è½½æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      document.querySelectorAll('.download-file-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.getAttribute('data-index') || '0');
          downloadSingleFile(index);
        });
      });
    }
    
    // æ‰“åŒ…å¹¶ä¸‹è½½æ–‡ä»¶
    async function packAndDownload() {
      console.log('æ‰“åŒ…å¹¶ä¸‹è½½æ–‡ä»¶');
      
      if (files.length === 0) {
        alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½æç¤º
      if (downloadBtn) {
        downloadBtn.textContent = 'æ‰“åŒ…ä¸­...';
        downloadBtn.disabled = true;
      }
      
      try {
        // åˆ›å»ºä¸€ä¸ªæ–°çš„ JSZip å®ä¾‹
        const zip = new JSZip();
        
        // ç¡®å®šä½¿ç”¨å“ªäº›æ–‡ä»¶åï¼ˆåŸå§‹åç§°æˆ–é¢„è§ˆåç§°ï¼‰
        // å¦‚æœå·²æ‰§è¡Œé‡å‘½åï¼Œåˆ™ä½¿ç”¨å½“å‰æ–‡ä»¶å
        // å¦‚æœåªæ˜¯é¢„è§ˆï¼Œåˆ™ä½¿ç”¨é¢„è§ˆåç§°
        
        // æ·»åŠ æ–‡ä»¶åˆ° zip
        const promises = [];
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileName = file.name;
          
          // å¦‚æœæ˜¯é€šè¿‡æ–‡ä»¶è¾“å…¥é€‰æ‹©çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è·å–æ–‡ä»¶å†…å®¹
          if (file.originalFile) {
            zip.file(fileName, file.originalFile);
          } else {
            // å¯¹äºæ¨¡æ‹Ÿæ–‡ä»¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„æ–‡æœ¬å†…å®¹
            const content = `è¿™æ˜¯æ–‡ä»¶ ${fileName} çš„æ¨¡æ‹Ÿå†…å®¹ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šåŒ…å«çœŸå®çš„æ–‡ä»¶å†…å®¹ã€‚`;
            zip.file(fileName, content);
          }
        }
        
        // ç”Ÿæˆ zip æ–‡ä»¶
        const zipContent = await zip.generateAsync({ type: 'blob' });
        
        // ä½¿ç”¨ FileSaver ä¿å­˜ zip æ–‡ä»¶
        saveAs(zipContent, 'é‡å‘½åæ–‡ä»¶.zip');
        
        console.log('æ–‡ä»¶æ‰“åŒ…ä¸‹è½½æˆåŠŸ');
      } catch (error) {
        console.error('æ‰“åŒ…ä¸‹è½½å‡ºé”™:', error);
        alert('æ‰“åŒ…ä¸‹è½½å‡ºé”™: ' + error.message);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (downloadBtn) {
          downloadBtn.textContent = 'æ‰“åŒ…ä¸‹è½½';
          downloadBtn.disabled = false;
        }
      }
    }
    
    // ä¸‹è½½å•ä¸ªæ–‡ä»¶
    function downloadSingleFile(index) {
      console.log('ä¸‹è½½å•ä¸ªæ–‡ä»¶', index);
      
      if (index < 0 || index >= files.length) {
        console.error('æ–‡ä»¶ç´¢å¼•æ— æ•ˆ');
        return;
      }
      
      const file = files[index];
      
      try {
        if (file.originalFile) {
          // å¦‚æœæœ‰åŸå§‹æ–‡ä»¶å¯¹è±¡ï¼Œä½¿ç”¨å®ƒåˆ›å»ºä¸€ä¸ª Blob
          const blob = new Blob([file.originalFile], { type: file.originalFile.type });
          saveAs(blob, file.name);
        } else if (file.path && file.path.startsWith('blob:')) {
          // å¦‚æœæœ‰ blob URLï¼Œç›´æ¥ä½¿ç”¨å®ƒ
          fetch(file.path)
            .then(response => response.blob())
            .then(blob => saveAs(blob, file.name))
            .catch(error => {
              console.error('ä¸‹è½½æ–‡ä»¶å‡ºé”™:', error);
              alert('ä¸‹è½½æ–‡ä»¶å‡ºé”™: ' + error.message);
            });
        } else {
          // å¯¹äºæ¨¡æ‹Ÿæ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„æ–‡æœ¬å†…å®¹
          const content = `è¿™æ˜¯æ–‡ä»¶ ${file.name} çš„æ¨¡æ‹Ÿå†…å®¹ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šåŒ…å«çœŸå®çš„æ–‡ä»¶å†…å®¹ã€‚`;
          const blob = new Blob([content], { type: 'text/plain' });
          saveAs(blob, file.name);
        }
        
        console.log('æ–‡ä»¶ä¸‹è½½æˆåŠŸ');
      } catch (error) {
        console.error('ä¸‹è½½æ–‡ä»¶å‡ºé”™:', error);
        alert('ä¸‹è½½æ–‡ä»¶å‡ºé”™: ' + error.message);
      }
    }
    
    // åˆå§‹åŒ–é¡µé¢
    console.log('æ–‡ä»¶é‡å‘½åå·¥å…·åˆå§‹åŒ–å®Œæˆ');
  });
</script> 